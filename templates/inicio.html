<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Biométrico - Inicio</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
      body {
        background: url("{{ url_for('static', filename='img/5447586.jpg') }}") no-repeat center center fixed;
        background-size: cover;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Poppins', sans-serif;
      }
  </style>
</head>
<body>

  <div class="main-card">
    <div class="wave-top">
      <img src="{{ url_for('static', filename='img/este.png') }}" alt="Decoración ondulada">
    </div>

    <header>
      <img src="{{ url_for('static', filename='img/escudomx.png') }}" alt="Logo Izquierdo">
      <img src="{{ url_for('static', filename='img/Logousila2.png') }}" alt="Logo Derecho">
    </header>

    <div class="datetime" id="fecha-hora"></div>

    <!-- Contenedor del lector y tarjeta juntos (misma fila) -->
    <div class="lector-container">
      <main>
        <h3>Coloque su huella</h3>
        <div id="lector" onclick="simularHuella()">
          <i class="bi bi-fingerprint" style="font-size:60px; color:#161716;"></i>
        </div>
        <div id="mensaje"></div>
      </main>

      <!-- Tarjeta resultado -->
      <div class="resultado-container" id="resultado">
        <div class="empleado-foto">
          <img id="foto-empleado" src="" alt="Foto del empleado">
        </div>
        <div class="empleado-datos">
          <h4 class="bienvenido">¡BIENVENIDO!</h4>
          <p><strong>Nombre:</strong> <span id="nombre-empleado"></span></p>
          <p><strong>Puesto:</strong> <span id="puesto-empleado"></span></p>
          <p><strong>Entrada:</strong> <span id="hora-entrada"></span></p>
          <p><strong>Salida:</strong> <span id="hora-salida"></span></p>
          <p><strong>Retraso:</strong> <span id="retraso"></span></p>
        </div>
      </div>
    </div>

    <footer>
      © 2025 H. Ayuntamiento de San Felipe Usila, Oaxaca
    </footer>

    <button id="btn-admin" class="btn" onclick="abrirModalAdmin()">
      <i class="bi bi-gear-fill"></i> Administrador
    </button>
  </div>

  <!-- Modal administrador -->
  <div class="modal fade" id="adminModal" tabindex="-1" aria-labelledby="adminModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="{{ url_for('admin_access_post') }}">
          <div class="modal-header">
            <h5 class="modal-title">Acceso Administrador</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="password" name="password" class="form-control mb-2" placeholder="Contraseña" id="password-admin" required>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Entrar</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function actualizarFechaHora() {
      const opciones = {
        timeZone: "America/Mexico_City",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
      };
      const ahora = new Date();
      const fecha = ahora.toLocaleDateString("es-MX", { day: "2-digit", month: "2-digit", year: "2-digit" });
      const hora = ahora.toLocaleTimeString("es-MX", opciones);
      document.getElementById("fecha-hora").textContent = `${fecha}   ${hora}`;
    }
    setInterval(actualizarFechaHora, 1000);
    actualizarFechaHora();

    function abrirModalAdmin() {
      var modal = new bootstrap.Modal(document.getElementById('adminModal'));
      modal.show();
    }

    const adminModalEl = document.getElementById('adminModal');
    adminModalEl.addEventListener('hidden.bs.modal', () => {
      document.getElementById('password-admin').value = '';
    });

    function simularHuella() {
      const lector = document.getElementById("lector");
      const mensaje = document.getElementById("mensaje");
      const resultado = document.getElementById("resultado");
      const baseRuta = "{{ url_for('static', filename='uploads/') }}";

      lector.style.background = "orange";
      mensaje.innerText = "Verificando huella...";

      fetch('/buscar_empleado', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_huella: 3 })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          mensaje.innerText = "Huella no reconocida";
          lector.style.background = "red";
          resultado.style.display = "none";
          return;
        }

        lector.style.background = "green";
        mensaje.innerText = "Huella reconocida";
        resultado.style.display = "flex";
        resultado.classList.add("mostrar");

        document.getElementById("nombre-empleado").innerText = data.nombre;
        document.getElementById("puesto-empleado").innerText = data.puesto;
        document.getElementById("foto-empleado").src = baseRuta + data.foto;

        const ahora = new Date();
        const horaActual = ahora.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        if (data.tipo.includes("entrada")) {
          document.getElementById("hora-entrada").innerText = horaActual;
          document.getElementById("hora-salida").innerText = "—";
          document.getElementById("retraso").innerText = data.retraso;
        } else {
          document.getElementById("hora-salida").innerText = horaActual;
        }

        //Ocultar resultados después de 3 segundos
        setTimeout(() => {
          resultado.classList.remove("mostrar");
          lector.style.background = "rgba(100, 100, 100, 0.3)";
          mensaje.innerText = "Coloca tu huella para registrar asistencia";
          setTimeout(() => resultado.style.display = "none", 500);
        }, 3000);
      })
      .catch(err => {
        console.error(err);
        mensaje.innerText = "Error al conectar con el servidor";
        lector.style.background = "red";
      });
    }
  </script>
</body>
</html>
